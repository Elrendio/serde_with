language: rust
sudo: false
cache: cargo

notifications:
  email: false

branches:
  only:
    # Enable building pull requests.
    - master
    # This is where pull requests from "bors r+" are built.
    - staging
    # This is where pull requests from "bors try" are built.
    - trying

matrix:
  include:
    - name: "Bors (1.26.2)"
      if: branch = staging OR branch = trying OR type = cron
      rust: 1.26.2
    - name: "Bors (stable)"
      if: branch = staging OR branch = trying OR type = cron
      rust: stable
    - name: "Bors (beta)"
      if: branch = staging OR branch = trying OR type = cron
      rust: beta
    - name: "Bors (nightly)"
      if: branch = staging OR branch = trying OR type = cron
      rust: nightly
    - name: "PR Open"
      if: type = pull_request AND branch = master
      rust: stable
    - name: "Minimal Versions"
      rust: nightly
      script:
        - set -e
        - cargo generate-lockfile -Z minimal-versions
        - cargo build --verbose --all --all-features
        - cargo test --verbose --all --all-features

# https://levans.fr/rust_travis_cache.html
# Need to cache the whole `.cargo` directory to keep .crates.toml for
# cargo-update to work
cache:
  directories:
    - /home/travis/.cargo

# But don't cache the cargo registry
before_cache:
  - rm -rf /home/travis/.cargo/registry

before_script:
  # skip this step for 1.26.2
  - ( test $TRAVIS_RUST_VERSION = "1.26.2" || rustup component add clippy-preview )

script:
  - set -e
  - |
    for FEATURES_COMMAND in "--no-default-features" "" "--features=chrono" "--features=json" "--all-features"
    do
      cargo build --verbose --all ${FEATURES_COMMAND}
      # skip this step for 1.26.2
      ( test $TRAVIS_RUST_VERSION = "1.26.2" || cargo clippy --verbose --all ${FEATURES_COMMAND} )
      cargo test --verbose --all ${FEATURES_COMMAND}
    done
